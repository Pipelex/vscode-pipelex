# CLAUDE.md

## Project Overview
Fork of [tamasfe/taplo](https://github.com/tamasfe/taplo) (TOML toolkit) extended with Pipelex Language (MTHDS) support.
Polyglot monorepo: Rust workspace + TypeScript VS Code extension + JS npm packages + VitePress docs site.

## Critical Rule: Preserve Upstream Taplo Behavior
**By default, unless expressly and clearly stated otherwise, all existing taplo upstream features and behavior must be kept as-is.** Do not modify, remove, or alter any taplo functionality. Our work is exclusively focused on **adding** new features for MTHDS files and the Pipelex VS Code extension. When making changes, ensure they do not regress or interfere with existing TOML support.

**Exception — bug fixes in common code:** If fixing a bug requires modifying shared/upstream taplo code (e.g. crates outside of MTHDS-specific paths), you must explicitly notify the developer before making the change, explaining what the bug is, which common code is affected, and why the fix is necessary.

## Repository Structure

### Upstream Taplo crates
- `crates/taplo/` - Core Rust library (parser, formatter, DOM)
- `crates/taplo-cli/` - Upstream CLI tool (binary: `taplo`)
- `crates/taplo-lsp/` - Language server (IDE-agnostic)
- `crates/taplo-common/` - Shared utilities (schemas, config)
- `crates/taplo-wasm/` - WASM bindings (target: wasm32-unknown-unknown)
- `crates/lsp-async-stub/` - Async LSP framework

### Pipelex-specific crates
- `crates/pipelex-cli/` - **Our CLI** (binary: `plxt`). Thin wrapper around `taplo-cli` that adds Pipelex config discovery (`.pipelex/toml_config.toml` first, then `.taplo.toml` fallback), `PIPELEX_CONFIG` env var, and wraps LSP with `MthdsEnvironment`. Delegates all standard commands (format, lint, get) to taplo-cli unchanged.
- `crates/pipelex-common/` - Pipelex shared utilities (includes `MthdsEnvironment` for config discovery)

### VS Code extension & other
- `editors/vscode/` - VS Code extension (TypeScript)
- `editors/vscode/src/pipelex/` - MTHDS-specific extension code
- `editors/vscode/src/syntax/mthds/` - MTHDS grammar generator (generates mthds.tmLanguage.json)
- `js/` - npm packages (@taplo/core, @taplo/cli, @taplo/lib, @taplo/lsp)
- `site/` - Documentation site (VitePress + Tailwind)
- `test-data/` - Test fixtures for TOML/MTHDS parsing
- `test-data/mthds/` - MTHDS grammar test fixtures

## Makefile Targets
- `make ext` - **Full extension rebuild**: compiles Rust → WASM → JS bundle (`ext-deps`), then builds the VS Code extension. Run this after any Rust LSP change to test in the Extension Host.
- `make cli` - Build the `plxt` CLI binary (release mode)
- `make vsix` - Package the extension into a `.vsix` file (runs `ext` first)
- `make ext-install` - Build, package, and install the `.vsix` into Cursor or VS Code
- `make ext-uninstall` - Uninstall the extension from the IDE
- `make test` - Run all tests (Rust crates + VS Code extension vitest)
- `make check` - Quick compilation checks (CLI + WASM target)
- `make clean` - Remove all build artifacts (cargo, JS dist, VSIX)
- `make sync-grammar` - Copy MTHDS TextMate grammar to the website repo

## Other Build Commands
- `cargo test -p taplo` - Run core Rust tests
- `cargo test` - Run all Rust tests
- `cargo check -p taplo-wasm --target wasm32-unknown-unknown` - Check WASM compilation
- `taplo fmt --check --diff` - Check TOML formatting (project dogfoods taplo)
- `cargo run -- fmt --check` - Check formatting via built binary
- `cd editors/vscode && yarn test` - Run semantic token provider tests (vitest)

## Key Technical Details
- **Rust MSRV**: 1.74 (CI tests against this)
- **VS Code engine**: ^1.90.0
- **Package manager**: Yarn 4 (via corepack)
- **Main branch**: `main`
- **Rust formatter**: rustfmt (config in `rustfmt.toml`)
- **TOML formatter**: taplo (config in `taplo.toml`)
- **No ESLint/Prettier** for TypeScript code in editors/vscode
- **GitHub organization**: Pipelex (repo: `Pipelex/vscode-pipelex`)
- **Upstream remote**: `tamasfe/taplo` (read-only, for syncing upstream changes only)
- **`gh` CLI**: Always target our repo explicitly (`--repo Pipelex/vscode-pipelex` or equivalent) — do not rely on implicit repo detection, which may resolve to upstream

## MTHDS Language
- MTHDS files use `.mthds` extension
- Grammar generated by `editors/vscode/src/syntax/mthds/` (run `yarn build:syntax`)
- **Generated grammar:** `mthds.tmLanguage.json` — produced by the generator, do not hand-edit
- **Static injection wrappers:** `mthds.frontmatter.tmLanguage.json` and `mthds.markdown.tmLanguage.json` — hand-edited files that delegate to `source.mthds` (same pattern as upstream `toml.frontmatter.tmLanguage.json` / `toml.markdown.tmLanguage.json`)
- Semantic tokens: mthdsConcept, mthdsPipeType, mthdsDataVariable, mthdsPipeName, mthdsPipeSection, mthdsConceptSection, mthdsModelRef
- MTHDS extension code lives in `editors/vscode/src/pipelex/`

## Don't Edit
- `Cargo.lock` - Auto-generated by cargo
- `mthds.tmLanguage.json` / `toml.tmLanguage.json` - Generated TextMate grammars (edit source generators instead). Note: the `*.frontmatter.tmLanguage.json` and `*.markdown.tmLanguage.json` files are static wrappers and may be edited directly.
- `node_modules/` and `target/` - Build artifacts

## CI/CD
- GitHub Actions: `ci.yaml` (fmt check, cargo test, WASM check, MSRV tests)
- Releases: `releases.yaml` — PyPI, VS Code Marketplace, Open VSX
- Auto-tagging via inline shell in `ci.yaml`
- **Enterprise allowlist:** Pipelex Enterprise restricts third-party actions. Only 4 are allowed (`Swatinem/rust-cache`, `PyO3/maturin-action`, `pypa/gh-action-pypi-publish`, `peaceiris/actions-gh-pages`) — all SHA-pinned in workflows. See `docs/dev/release-publishing.md` for details and allowlist management.
- **When adding a new third-party action:** either replace with inline shell, or add its `owner/repo@*` pattern to the enterprise allowlist at `github.com/enterprises/Pipelex/settings/actions/policies` and SHA-pin in the workflow.
