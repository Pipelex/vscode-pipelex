# CLAUDE.md

## Project Overview
Fork of [tamasfe/taplo](https://github.com/tamasfe/taplo) (TOML toolkit) extended with Pipelex Language (MTHDS) support.
Polyglot monorepo: Rust workspace + TypeScript VS Code extension + JS npm packages + VitePress docs site.

## Critical Rule: Preserve Upstream Taplo Behavior
**By default, unless expressly and clearly stated otherwise, all existing taplo upstream features and behavior must be kept as-is.** Do not modify, remove, or alter any taplo functionality. Our work is exclusively focused on **adding** new features for MTHDS files and the Pipelex VS Code extension. When making changes, ensure they do not regress or interfere with existing TOML support.

**Exception â€” bug fixes in common code:** If fixing a bug requires modifying shared/upstream taplo code (e.g. crates outside of MTHDS-specific paths), you must explicitly notify the developer before making the change, explaining what the bug is, which common code is affected, and why the fix is necessary.

## Repository Structure
- `crates/taplo/` - Core Rust library (parser, formatter, DOM)
- `crates/taplo-cli/` - CLI tool
- `crates/taplo-lsp/` - Language server (IDE-agnostic)
- `crates/taplo-common/` - Shared utilities (schemas, config)
- `crates/taplo-wasm/` - WASM bindings (target: wasm32-unknown-unknown)
- `crates/lsp-async-stub/` - Async LSP framework
- `editors/vscode/` - VS Code extension (TypeScript)
- `editors/vscode/src/pipelex/` - MTHDS-specific extension code
- `editors/vscode/src/syntax/mthds/` - MTHDS grammar generator (generates mthds.tmLanguage.json)
- `js/` - npm packages (@taplo/core, @taplo/cli, @taplo/lib, @taplo/lsp)
- `site/` - Documentation site (VitePress + Tailwind)
- `test-data/` - Test fixtures for TOML/MTHDS parsing
- `test-data/mthds/` - MTHDS grammar test fixtures

## Build Commands
- `cargo test -p taplo` - Run core Rust tests
- `cargo test` - Run all Rust tests
- `cargo check -p taplo-wasm --target wasm32-unknown-unknown` - Check WASM compilation
- `cd editors/vscode && yarn install && yarn build` - Build VS Code extension
- `taplo fmt --check --diff` - Check TOML formatting (project dogfoods taplo)
- `cargo run -- fmt --check` - Check formatting via built binary
- `cd editors/vscode && yarn test` - Run semantic token provider tests (vitest)

## Key Technical Details
- **Rust MSRV**: 1.74 (CI tests against this)
- **VS Code engine**: ^1.90.0
- **Package manager**: Yarn 4 (via corepack)
- **Main branch**: `master` (not main)
- **Rust formatter**: rustfmt (config in `rustfmt.toml`)
- **TOML formatter**: taplo (config in `taplo.toml`)
- **No ESLint/Prettier** for TypeScript code in editors/vscode

## MTHDS Language
- MTHDS files use `.mthds` extension
- Grammar generated by `editors/vscode/src/syntax/mthds/` (run `yarn build:syntax`)
- Semantic tokens: mthdsConcept, mthdsPipeType, mthdsDataVariable, mthdsPipeName, mthdsPipeSection, mthdsConceptSection, mthdsModelRef
- MTHDS extension code lives in `editors/vscode/src/pipelex/`

## Don't Edit
- `Cargo.lock` - Auto-generated by cargo
- `*.tmLanguage.json` - Generated TextMate grammars (edit source generators instead)
- `node_modules/` and `target/` - Build artifacts

## CI/CD
- GitHub Actions: `ci.yaml` (fmt check, cargo test, WASM check, MSRV tests)
- Releases: Multi-platform builds -> crates.io, npm, PyPI, VS Code Marketplace, Docker
- Auto-tagging via `tamasfe/auto-tag`
