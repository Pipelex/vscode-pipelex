name: Releases

on:
  push:
    tags:
      - release-pipelex-*
  pull_request:
  workflow_dispatch:

jobs:
  wait_for_ci:
    name: Wait for CI Workflow
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI
        if: github.event_name == 'push'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Waiting for 'Test on Rust stable' check on ${{ github.sha }}..."
          for i in $(seq 1 180); do
            result=$(gh api repos/${{ github.repository }}/commits/${{ github.sha }}/check-runs \
              --jq '.check_runs[] | select(.name == "Test on Rust stable")')
            status=$(echo "$result" | jq -r '.status')
            conclusion=$(echo "$result" | jq -r '.conclusion')
            if [ "$status" = "completed" ]; then
              if [ "$conclusion" = "success" ]; then
                echo "CI passed"; exit 0
              else
                echo "CI failed (conclusion: $conclusion)"; exit 1
              fi
            fi
            echo "  status=$status, waiting 10s... ($i/180)"
            sleep 10
          done
          echo "Timed out waiting for CI (30 min)"; exit 1

  get_version:
    runs-on: ubuntu-latest
    needs: ["wait_for_ci"]
    outputs:
      plxt-cli: ${{ steps.plxt-cli.outputs.version || '' }}
      vscode-ext: ${{ steps.vscode-ext.outputs.version || '' }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: Retrieve plxt-cli release version
        if: startsWith(github.ref, 'refs/tags/release-pipelex-cli-0')
        run: echo "version=$(echo ${GITHUB_REF#refs/tags/release-pipelex-cli-})" >> $GITHUB_OUTPUT
        id: plxt-cli
      - name: Retrieve vscode extension release version
        if: startsWith(github.ref, 'refs/tags/release-pipelex-0')
        run: echo "version=$(echo ${GITHUB_REF#refs/tags/release-pipelex-})" >> $GITHUB_OUTPUT
        id: vscode-ext

  publish_vscode_extension:
    name: Publish VSCode Extension
    needs: ["wait_for_ci", "get_version"]
    if: startsWith(github.ref, 'refs/tags/release-pipelex-0') || contains(fromJSON('["workflow_dispatch", "pull_request"]'), github.event_name)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: Install latest Rust toolchain
        run: |
          rustup update --no-self-update
          rustup target add wasm32-unknown-unknown
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - name: Install Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: lts/*
      - name: Enable latest yarn
        run: corepack enable
      - name: Build @pipelex/lsp WASM bundle
        run: yarn install && yarn build
        working-directory: js/lsp
      - name: Extension NPM Install
        run: yarn
        working-directory: editors/vscode
      - name: Install vsce
        run: npm install -g @vscode/vsce
      - name: Package Extension
        run: vsce package --baseImagesUrl https://raw.githubusercontent.com/Pipelex/vscode-pipelex/main/editors/vscode --no-yarn # Microsoft doesn't support anything other than npm and yarn@v1
        working-directory: editors/vscode
      - name: Publish extension to microsoft marketplace
        if: github.event_name == 'push'
        run: vsce publish --baseImagesUrl https://raw.githubusercontent.com/Pipelex/vscode-pipelex/main/editors/vscode -p $VSCE_TOKEN --no-yarn
        working-directory: editors/vscode
        env:
          VSCE_TOKEN: ${{ secrets.VSCE_TOKEN }}
      - name: Install ovsx
        run: npm install -g ovsx
      - name: Publish Open VSX Extension
        if: github.event_name == 'push'
        run: ovsx publish --baseImagesUrl https://raw.githubusercontent.com/Pipelex/vscode-pipelex/main/editors/vscode -p $OPEN_VSX_TOKEN "pipelex-${{ needs.get_version.outputs.vscode-ext }}.vsix"
        working-directory: editors/vscode
        env:
          OPEN_VSX_TOKEN: ${{ secrets.OPEN_VSX_TOKEN }}

  # ── plxt (pipelex-cli) PyPI publishing ──────────────────────────────────────

  pypi_build_plxt:
    name: Build plxt wheels (${{ matrix.os }}-${{ matrix.arch }})
    if: startsWith(github.ref, 'refs/tags/release-pipelex-cli-0') || contains(fromJSON('["workflow_dispatch", "pull_request"]'), github.event_name)
    needs: ["wait_for_ci"]
    runs-on: ${{ matrix.os }}-latest
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu, windows, macos]
        arch: [x86, x64, aarch64]
        exclude:
          - os: windows
            arch: aarch64
          - os: macos
            arch: x86
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: Set CFLAGS for aarch64 on Ubuntu
        if: matrix.os == 'ubuntu' && matrix.arch == 'aarch64'
        run: |
          echo "CFLAGS_aarch64_unknown_linux_gnu=-D__ARM_ARCH=8" >> $GITHUB_ENV
      - name: Build sdist
        if: matrix.os == 'ubuntu' && matrix.arch == 'x64'
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021 # v1.50.0
        with:
          command: sdist
          args: --out dist
      - name: Build wheels
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021 # v1.50.0
        with:
          target: ${{ matrix.arch }}
          args: --release --out dist
          sccache: "true"
          manylinux: auto
      - name: Upload wheels
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: plxt-wheels-${{ matrix.os }}-${{ matrix.arch }}
          path: dist

  pypi_test_plxt:
    name: Test plxt wheels (${{ matrix.os }})
    needs: ["pypi_build_plxt"]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - windows-latest
          - ubuntu-latest
          - macos-latest
    steps:
      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          pattern: plxt-wheels-*
          path: wheels
          merge-multiple: true
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3"
      - run: pip install pipelex-tools --no-index --find-links wheels/
      - run: plxt help

  pypi_publish_plxt:
    name: PyPI publish plxt
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/release-pipelex-cli-0')
    needs: ["pypi_test_plxt"]
    permissions:
      id-token: write
    steps:
      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          pattern: plxt-wheels-*
          path: dist
          merge-multiple: true
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # release/v1
