name: Releases

on:
  push:
    tags:
      - release-*
  pull_request:
  workflow_dispatch:

# TODO: github doesn't support regex matching in if expressions for some reason,
# so these jobs all expect zero-versioned release tags...

jobs:
  wait_for_ci:
    name: Wait for CI Workflow
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI
        if: github.event_name != 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Waiting for 'Test on Rust stable' check on ${{ github.sha }}..."
          for i in $(seq 1 180); do
            result=$(gh api repos/${{ github.repository }}/commits/${{ github.sha }}/check-runs \
              --jq '.check_runs[] | select(.name == "Test on Rust stable")')
            status=$(echo "$result" | jq -r '.status')
            conclusion=$(echo "$result" | jq -r '.conclusion')
            if [ "$status" = "completed" ]; then
              if [ "$conclusion" = "success" ]; then
                echo "CI passed"; exit 0
              else
                echo "CI failed (conclusion: $conclusion)"; exit 1
              fi
            fi
            echo "  status=$status, waiting 10s... ($i/180)"
            sleep 10
          done
          echo "Timed out waiting for CI (30 min)"; exit 1

  get_version:
    runs-on: ubuntu-latest
    needs: ["wait_for_ci"]
    outputs:
      cli: ${{ steps.cli.outputs.version || '' }}
      plxt-cli: ${{ steps.plxt-cli.outputs.version || '' }}
      vscode-ext: ${{ steps.vscode-ext.outputs.version || '' }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: Retrieve taplo-cli release version
        if: startsWith(github.ref, 'refs/tags/release-taplo-cli-0')
        run: echo "version=$(echo ${GITHUB_REF#refs/tags/release-taplo-cli-})" >> $GITHUB_OUTPUT
        id: cli
      - name: Retrieve plxt-cli release version
        if: startsWith(github.ref, 'refs/tags/release-pipelex-cli-0')
        run: echo "version=$(echo ${GITHUB_REF#refs/tags/release-pipelex-cli-})" >> $GITHUB_OUTPUT
        id: plxt-cli
      - name: Retrieve vscode extension release version
        if: startsWith(github.ref, 'refs/tags/release-pipelex-0')
        run: echo "version=$(echo ${GITHUB_REF#refs/tags/release-pipelex-})" >> $GITHUB_OUTPUT
        id: vscode-ext

  cargo_publish_taplo:
    name: Cargo publish taplo
    runs-on: ubuntu-latest
    needs: ["wait_for_ci"]
    if: startsWith(github.ref, 'refs/tags/release-taplo-0') || contains(fromJSON('["workflow_dispatch", "pull_request"]'), github.event_name)
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: Install latest Rust toolchain
        run: rustup update --no-self-update
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - name: Publish to Crates.io
        if: github.event_name == 'push'
        env:
          CRATES_IO_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: |
          for attempt in 1 2 3; do
            echo "Attempt $attempt of 3"
            if (cd crates/taplo && cargo publish --allow-dirty --token "$CRATES_IO_TOKEN"); then
              exit 0
            fi
            if [ "$attempt" -lt 3 ]; then echo "Retrying in 300s..."; sleep 300; fi
          done
          echo "Failed after 3 attempts"; exit 1

  cargo_publish_taplo_cli:
    name: Cargo publish taplo-cli
    runs-on: ubuntu-latest
    needs: ["wait_for_ci"]
    if: startsWith(github.ref, 'refs/tags/release-taplo-cli-0') || contains(fromJSON('["workflow_dispatch", "pull_request"]'), github.event_name)
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: Install latest Rust toolchain
        run: rustup update --no-self-update
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - name: Publish to Crates.io
        if: github.event_name == 'push'
        env:
          CRATES_IO_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: |
          for attempt in 1 2 3; do
            echo "Attempt $attempt of 3"
            if (cd crates/taplo-cli && cargo publish --allow-dirty --token "$CRATES_IO_TOKEN"); then
              exit 0
            fi
            if [ "$attempt" -lt 3 ]; then echo "Retrying in 300s..."; sleep 300; fi
          done
          echo "Failed after 3 attempts"; exit 1

  cargo_publish_taplo_common:
    name: Cargo publish taplo-common
    runs-on: ubuntu-latest
    needs: ["wait_for_ci"]
    if: startsWith(github.ref, 'refs/tags/release-taplo-common-0') || contains(fromJSON('["workflow_dispatch", "pull_request"]'), github.event_name)
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: Install latest Rust toolchain
        run: rustup update --no-self-update
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - name: Publish to Crates.io
        if: github.event_name == 'push'
        env:
          CRATES_IO_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: |
          for attempt in 1 2 3; do
            echo "Attempt $attempt of 3"
            if (cd crates/taplo-common && cargo publish --allow-dirty --token "$CRATES_IO_TOKEN"); then
              exit 0
            fi
            if [ "$attempt" -lt 3 ]; then echo "Retrying in 300s..."; sleep 300; fi
          done
          echo "Failed after 3 attempts"; exit 1

  cargo_publish_taplo_lsp:
    name: Cargo publish taplo-lsp
    runs-on: ubuntu-latest
    needs: ["wait_for_ci"]
    if: startsWith(github.ref, 'refs/tags/release-taplo-lsp-0') || contains(fromJSON('["workflow_dispatch", "pull_request"]'), github.event_name)
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: Install latest Rust toolchain
        run: rustup update --no-self-update
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - name: Publish to Crates.io
        if: github.event_name == 'push'
        env:
          CRATES_IO_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: |
          for attempt in 1 2 3; do
            echo "Attempt $attempt of 3"
            if (cd crates/taplo-lsp && cargo publish --allow-dirty --token "$CRATES_IO_TOKEN"); then
              exit 0
            fi
            if [ "$attempt" -lt 3 ]; then echo "Retrying in 300s..."; sleep 300; fi
          done
          echo "Failed after 3 attempts"; exit 1

  cargo_publish_lsp_async_stub:
    name: Cargo publish lsp-async-stub
    runs-on: ubuntu-latest
    needs: ["wait_for_ci"]
    if: startsWith(github.ref, 'refs/tags/release-lsp-async-stub-0') || contains(fromJSON('["workflow_dispatch", "pull_request"]'), github.event_name)
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: Install latest Rust toolchain
        run: rustup update --no-self-update
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - name: Publish to Crates.io
        if: github.event_name == 'push'
        env:
          CRATES_IO_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: |
          for attempt in 1 2 3; do
            echo "Attempt $attempt of 3"
            if (cd crates/lsp-async-stub && cargo publish --allow-dirty --token "$CRATES_IO_TOKEN"); then
              exit 0
            fi
            if [ "$attempt" -lt 3 ]; then echo "Retrying in 300s..."; sleep 300; fi
          done
          echo "Failed after 3 attempts"; exit 1

  npm_publish_taplo_core:
    name: NPM publish @taplo/core
    runs-on: ubuntu-latest
    needs: ["wait_for_ci"]
    if: startsWith(github.ref, 'refs/tags/release-taplo__core-0') || contains(fromJSON('["workflow_dispatch", "pull_request"]'), github.event_name)
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: lts/*
          registry-url: "https://registry.npmjs.org"
      - name: Install latest Rust toolchain
        run: |
          rustup update --no-self-update
          rustup target add wasm32-unknown-unknown
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - name: Publish to NPM
        if: github.event_name == 'push'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          for attempt in 1 2 3; do
            echo "Attempt $attempt of 3"
            if (cd js/core && yarn install && yarn publish); then
              exit 0
            fi
            if [ "$attempt" -lt 3 ]; then echo "Retrying in 300s..."; sleep 300; fi
          done
          echo "Failed after 3 attempts"; exit 1

  npm_publish_taplo_cli:
    name: NPM publish @taplo/cli
    runs-on: ubuntu-latest
    needs: ["wait_for_ci"]
    if: startsWith(github.ref, 'refs/tags/release-taplo__cli-0') || contains(fromJSON('["workflow_dispatch", "pull_request"]'), github.event_name)
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: lts/*
          registry-url: "https://registry.npmjs.org"
      - name: Install latest Rust toolchain
        run: |
          rustup update --no-self-update
          rustup target add wasm32-unknown-unknown
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - name: Build Core
        working-directory: js/core
        run: yarn install && yarn build
      - name: Publish to NPM
        if: github.event_name == 'push'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          for attempt in 1 2 3; do
            echo "Attempt $attempt of 3"
            if (cd js/cli && yarn install && yarn publish); then
              exit 0
            fi
            if [ "$attempt" -lt 3 ]; then echo "Retrying in 300s..."; sleep 300; fi
          done
          echo "Failed after 3 attempts"; exit 1

  npm_publish_taplo_lsp:
    name: NPM publish @taplo/lsp
    runs-on: ubuntu-latest
    needs: ["wait_for_ci"]
    if: startsWith(github.ref, 'refs/tags/release-taplo__lsp-0') || contains(fromJSON('["workflow_dispatch", "pull_request"]'), github.event_name)
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: lts/*
          registry-url: "https://registry.npmjs.org"
      - name: Install latest Rust toolchain
        run: |
          rustup update --no-self-update
          rustup target add wasm32-unknown-unknown
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - name: Build Core
        working-directory: js/core
        run: yarn install && yarn build
      - name: Publish to NPM
        if: github.event_name == 'push'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          for attempt in 1 2 3; do
            echo "Attempt $attempt of 3"
            if (cd js/lsp && yarn install && yarn publish); then
              exit 0
            fi
            if [ "$attempt" -lt 3 ]; then echo "Retrying in 300s..."; sleep 300; fi
          done
          echo "Failed after 3 attempts"; exit 1

  npm_publish_taplo_lib:
    name: NPM publish @taplo/lib
    runs-on: ubuntu-latest
    needs: ["wait_for_ci"]
    if: startsWith(github.ref, 'refs/tags/release-taplo__lib-0') || contains(fromJSON('["workflow_dispatch", "pull_request"]'), github.event_name)
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: lts/*
          registry-url: "https://registry.npmjs.org"
      - name: Install latest Rust toolchain
        run: |
          rustup update --no-self-update
          rustup target add wasm32-unknown-unknown
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - name: Build Core
        working-directory: js/core
        run: yarn install && yarn build
      - name: Publish to NPM
        if: github.event_name == 'push'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          for attempt in 1 2 3; do
            echo "Attempt $attempt of 3"
            if (cd js/lib && yarn install && yarn publish); then
              exit 0
            fi
            if [ "$attempt" -lt 3 ]; then echo "Retrying in 300s..."; sleep 300; fi
          done
          echo "Failed after 3 attempts"; exit 1

  build_cli_windows:
    name: ${{ matrix.triple }}
    runs-on: windows-latest
    needs: ["wait_for_ci"]
    if: startsWith(github.ref, 'refs/tags/release-taplo-cli-0') || contains(fromJSON('["workflow_dispatch", "pull_request"]'), github.event_name)
    strategy:
      fail-fast: false
      matrix:
        include:
          - triple: i686-pc-windows-msvc
            platform: x86
          - triple: x86_64-pc-windows-msvc
            platform: x86_64
          - triple: aarch64-pc-windows-msvc
            platform: aarch64
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - run: rustup update
      - run: rustup target add ${{ matrix.triple }}

      - name: Build taplo
        env:
          RUSTFLAGS: '-C target-feature=+crt-static'
        run: |
          cargo build --verbose --release --bin taplo --target ${{ matrix.triple }}
          # zip
          Compress-Archive -Path ./target/${{ matrix.triple }}/release/taplo.exe -DestinationPath ./taplo-windows-${{ matrix.platform }}.zip
          # gzip
          $file = [System.IO.File]::Open('.\target\${{ matrix.triple }}\release\taplo.exe', [System.IO.FileMode]::Open)
          $archive = [System.IO.File]::Create('.\taplo-windows-${{ matrix.platform }}.gz')
          $compressor = [System.IO.Compression.GZipStream]::new($archive, [System.IO.Compression.CompressionMode]::Compress)
          $file.CopyTo($compressor)
          $compressor.Close()

      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: taplo-windows-${{ matrix.platform }}
          retention-days: 1
          compression-level: 0
          path: |
            ./taplo-*.gz
            ./taplo-*.zip

  build_cli_linux_musl:
    name: Build linux executables
    runs-on: ubuntu-latest
    needs: ["wait_for_ci", "get_version"]
    if: startsWith(github.ref, 'refs/tags/release-taplo-cli-0') || contains(fromJSON('["workflow_dispatch", "pull_request"]'), github.event_name)
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: Set up QEMU
        run: sudo apt-get update && sudo apt-get install -y qemu-user-static
      - name: Set up Docker Buildx
        run: |
          docker buildx create --driver=docker-container --use
      - name: Login to DockerHub
        if: github.event_name == 'push'
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login --password-stdin -u "${{ secrets.DOCKER_USERNAME }}"
      - name: Build
        env:
          RELEASE_TAG: ${{ needs.get_version.outputs.cli || 'dev' }}
          PUSH: ${{ github.event_name == 'push' }}
        run: |
          docker buildx bake
      - run: |
          mkdir -p ./target/wheels
          mv ./target/alpine/linux_*/taplo*.whl ./target/wheels/
      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: wheels-musl
          retention-days: 1
          compression-level: 0
          path: |
            ./target/wheels/*
      - run: |
          cd ./target/alpine
          mv ./linux_386/taplo ./linux_386/taplo-x86
          mv ./linux_amd64/taplo ./linux_amd64/taplo-x86_64
          mv ./linux_arm64/taplo ./linux_arm64/taplo-aarch64
          mv ./linux_arm_v7/taplo ./linux_arm_v7/taplo-armv7
      - name: Gzip files
        run: |
          gzip ./target/alpine/linux_*/taplo*
      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: taplo-linux
          compression-level: 0
          retention-days: 1
          path: |
            ./target/alpine/linux_*/taplo*.gz

  build_cli_macos:
    name: ${{ matrix.triple }}
    runs-on: macos-latest
    needs: ["wait_for_ci"]
    if: startsWith(github.ref, 'refs/tags/release-taplo-cli-0') || contains(fromJSON('["workflow_dispatch", "pull_request"]'), github.event_name)
    strategy:
      fail-fast: false
      matrix:
        include:
          - triple: x86_64-apple-darwin
            platform: x86_64
          - triple: aarch64-apple-darwin
            platform: aarch64
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - run: rustup update
      - run: rustup target add ${{ matrix.triple }}

      - name: Build taplo
        run: |
          cargo build --verbose --release --bins --target ${{ matrix.triple }}
          gzip -c ./target/${{ matrix.triple }}/release/taplo > ./taplo-darwin-${{ matrix.platform }}.gz

      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: taplo-macos-${{ matrix.platform }}
          retention-days: 1
          compression-level: 0
          path: |
            ./taplo-*.gz

  publish_cli:
    name: Release Taplo CLI binaries
    needs:
      - "get_version"
      - "build_cli_windows"
      - "build_cli_linux_musl"
      - "build_cli_macos"
    runs-on: ubuntu-latest
    env:
      GH_REPO: ${{ github.repository }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      DEBUG: api
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
      - name: Create GitHub release
        if: github.event_name == 'push'
        run: |
          gh release create --draft ${{ needs.get_version.outputs.cli }} --title "Taplo CLI ${{ needs.get_version.outputs.cli }}" --target $GITHUB_SHA taplo-windows-*/* taplo-macos-*/* taplo-linux-*/*

  publish_vscode_extension:
    name: Publish VSCode Extension
    needs: ["wait_for_ci", "get_version"]
    if: startsWith(github.ref, 'refs/tags/release-pipelex-0') || contains(fromJSON('["workflow_dispatch", "pull_request"]'), github.event_name)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: Install latest Rust toolchain
        run: |
          rustup update --no-self-update
          rustup target add wasm32-unknown-unknown
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - name: Install Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: lts/*
      - name: Enable latest yarn
        run: corepack enable
      - name: Build @pipelex/lsp WASM bundle
        run: yarn install && yarn build
        working-directory: js/lsp
      - name: Extension NPM Install
        run: yarn
        working-directory: editors/vscode
      - name: Install vsce
        run: npm install -g @vscode/vsce
      - name: Package Extension
        run: vsce package --baseImagesUrl https://raw.githubusercontent.com/Pipelex/vscode-pipelex/main/editors/vscode --no-yarn # Microsoft doesn't support anything other than npm and yarn@v1
        working-directory: editors/vscode
      - name: Publish extension to microsoft marketplace
        if: github.event_name == 'push'
        run: vsce publish --baseImagesUrl https://raw.githubusercontent.com/Pipelex/vscode-pipelex/main/editors/vscode -p $VSCE_TOKEN --no-yarn
        working-directory: editors/vscode
        env:
          VSCE_TOKEN: ${{ secrets.VSCE_TOKEN }}
      - name: Install ovsx
        run: npm install -g ovsx
      - name: Publish Open VSX Extension
        if: github.event_name == 'push'
        run: ovsx publish --baseImagesUrl https://raw.githubusercontent.com/Pipelex/vscode-pipelex/main/editors/vscode -p $OPEN_VSX_TOKEN "pipelex-${{ needs.get_version.outputs.vscode-ext }}.vsix"
        working-directory: editors/vscode
        env:
          OPEN_VSX_TOKEN: ${{ secrets.OPEN_VSX_TOKEN }}

  pypi_build_taplo_cli:
    name: Build python wheels
    if: startsWith(github.ref, 'refs/tags/release-taplo-cli-0') || contains(fromJSON('["workflow_dispatch", "pull_request"]'), github.event_name)
    needs: ["wait_for_ci"]
    runs-on: ${{ matrix.os }}-latest
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu, windows, macos]
        arch: [x86, x64, aarch64]
        exclude:
          - os: windows
            arch: aarch64
          - os: macos
            arch: x86
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: Set CFLAGS for aarch64 on Ubuntu
        if: matrix.os == 'ubuntu' && matrix.arch == 'aarch64'
        # Workaround issue cross-compiling to aarch64 https://github.com/bobzilladev/ring-poc
        run: |
          echo "CFLAGS_aarch64_unknown_linux_gnu=-D__ARM_ARCH=8" >> $GITHUB_ENV
      - name: Build sdist
        if: matrix.os == 'ubuntu' && matrix.arch == 'x64'
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021 # v1.50.0
        with:
          command: sdist
          args: --out dist
      - name: Build wheels
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021 # v1.50.0
        with:
          target: ${{ matrix.arch }}
          args: --release --out dist
          sccache: "true"
          manylinux: auto
      - name: Upload wheels
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: wheels-${{ matrix.os }}-${{ matrix.arch }}
          path: dist

  pypi_test_taplo_cli:
    name: Test python wheels
    needs: ["pypi_build_taplo_cli", "build_cli_linux_musl"]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - windows-latest
          - ubuntu-latest
          - macos-latest
    steps:
      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          pattern: wheels-*
          path: wheels
          merge-multiple: true
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3"
      - run: pip install taplo --no-index --find-links wheels/
      - run: taplo help

  pypi_publish_taplo_cli:
    name: PyPI publish taplo
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/release-taplo-cli-0')
    needs: ["pypi_test_taplo_cli"]
    permissions:
      id-token: write
    steps:
      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # release/v1

  # ── plxt (pipelex-cli) PyPI publishing ──────────────────────────────────────

  pypi_build_plxt:
    name: Build plxt wheels (${{ matrix.os }}-${{ matrix.arch }})
    if: startsWith(github.ref, 'refs/tags/release-pipelex-cli-0') || contains(fromJSON('["workflow_dispatch", "pull_request"]'), github.event_name)
    needs: ["wait_for_ci"]
    runs-on: ${{ matrix.os }}-latest
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu, windows, macos]
        arch: [x86, x64, aarch64]
        exclude:
          - os: windows
            arch: aarch64
          - os: macos
            arch: x86
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: Set CFLAGS for aarch64 on Ubuntu
        if: matrix.os == 'ubuntu' && matrix.arch == 'aarch64'
        run: |
          echo "CFLAGS_aarch64_unknown_linux_gnu=-D__ARM_ARCH=8" >> $GITHUB_ENV
      - name: Build sdist
        if: matrix.os == 'ubuntu' && matrix.arch == 'x64'
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021 # v1.50.0
        with:
          command: sdist
          args: --out dist
      - name: Build wheels
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021 # v1.50.0
        with:
          target: ${{ matrix.arch }}
          args: --release --out dist
          sccache: "true"
          manylinux: auto
      - name: Upload wheels
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: plxt-wheels-${{ matrix.os }}-${{ matrix.arch }}
          path: dist

  pypi_test_plxt:
    name: Test plxt wheels (${{ matrix.os }})
    needs: ["pypi_build_plxt"]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - windows-latest
          - ubuntu-latest
          - macos-latest
    steps:
      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          pattern: plxt-wheels-*
          path: wheels
          merge-multiple: true
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3"
      - run: pip install pipelex-tools --no-index --find-links wheels/
      - run: plxt help

  pypi_publish_plxt:
    name: PyPI publish plxt
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/release-pipelex-cli-0')
    needs: ["pypi_test_plxt"]
    permissions:
      id-token: write
    steps:
      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          pattern: plxt-wheels-*
          path: dist
          merge-multiple: true
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # release/v1
